/**
 * Internationalization (i18n) System
 * Comprehensive multi-language support with automatic detection and formatting
 */

class I18nManager {
  constructor() {
    this.currentLanguage = 'en';
    this.fallbackLanguage = 'en';
    this.translations = new Map();
    this.formatters = new Map();
    this.listeners = new Set();
    this.loadedLanguages = new Set();
    
    // Supported languages with their configurations
    this.supportedLanguages = {
      en: {
        name: 'English',
        nativeName: 'English',
        code: 'en',
        locale: 'en-US',
        rtl: false,
        flag: 'üá∫üá∏'
      },
      es: {
        name: 'Spanish',
        nativeName: 'Espa√±ol',
        code: 'es',
        locale: 'es-ES',
        rtl: false,
        flag: 'üá™üá∏'
      },
      fr: {
        name: 'French',
        nativeName: 'Fran√ßais',
        code: 'fr',
        locale: 'fr-FR',
        rtl: false,
        flag: 'üá´üá∑'
      },
      de: {
        name: 'German',
        nativeName: 'Deutsch',
        code: 'de',
        locale: 'de-DE',
        rtl: false,
        flag: 'üá©üá™'
      },
      hi: {
        name: 'Hindi',
        nativeName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
        code: 'hi',
        locale: 'hi-IN',
        rtl: false,
        flag: 'üáÆüá≥'
      },
      ar: {
        name: 'Arabic',
        nativeName: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
        code: 'ar',
        locale: 'ar-SA',
        rtl: true,
        flag: 'üá∏üá¶'
      },
      zh: {
        name: 'Chinese',
        nativeName: '‰∏≠Êñá',
        code: 'zh',
        locale: 'zh-CN',
        rtl: false,
        flag: 'üá®üá≥'
      },
      pt: {
        name: 'Portuguese',
        nativeName: 'Portugu√™s',
        code: 'pt',
        locale: 'pt-BR',
        rtl: false,
        flag: 'üáßüá∑'
      },
      ru: {
        name: 'Russian',
        nativeName: '–†—É—Å—Å–∫–∏–π',
        code: 'ru',
        locale: 'ru-RU',
        rtl: false,
        flag: 'üá∑üá∫'
      },
      ja: {
        name: 'Japanese',
        nativeName: 'Êó•Êú¨Ë™û',
        code: 'ja',
        locale: 'ja-JP',
        rtl: false,
        flag: 'üáØüáµ'
      }
    };
    
    this.initialize();
  }

  // Initialize i18n system
  async initialize() {
    // Detect user's preferred language
    const detectedLanguage = this.detectLanguage();
    
    // Load default language (English)
    await this.loadLanguage('en');
    
    // Load detected language if different from English
    if (detectedLanguage !== 'en') {
      await this.loadLanguage(detectedLanguage);
      this.setLanguage(detectedLanguage);
    }
    
    // Set up formatters
    this.setupFormatters();
    
    // Apply RTL if needed
    this.applyDirectionality();
    
    console.log(`[i18n] Initialized with language: ${this.currentLanguage}`);
  }

  // Detect user's preferred language
  detectLanguage() {
    // Check localStorage first
    const storedLanguage = localStorage.getItem('preferred-language');
    if (storedLanguage && this.supportedLanguages[storedLanguage]) {
      return storedLanguage;
    }
    
    // Check browser languages
    const browserLanguages = navigator.languages || [navigator.language];
    
    for (const browserLang of browserLanguages) {
      // Extract language code (e.g., 'en-US' -> 'en')
      const langCode = browserLang.split('-')[0].toLowerCase();
      
      if (this.supportedLanguages[langCode]) {
        return langCode;
      }
    }
    
    // Fallback to English
    return 'en';
  }

  // Load language translations
  async loadLanguage(languageCode) {
    if (this.loadedLanguages.has(languageCode)) {
      return;
    }

    try {
      // In a real application, this would load from a server or import files
      // For now, we'll use embedded translations
      const translations = await this.getTranslations(languageCode);
      this.translations.set(languageCode, translations);
      this.loadedLanguages.add(languageCode);
      
      console.log(`[i18n] Loaded translations for: ${languageCode}`);
    } catch (error) {
      console.error(`[i18n] Failed to load language ${languageCode}:`, error);
    }
  }

  // Get translations for a language (embedded for demo)
  async getTranslations(languageCode) {
    const translations = {
      en: {
        // Common
        'common.loading': 'Loading...',
        'common.error': 'Error',
        'common.success': 'Success',
        'common.cancel': 'Cancel',
        'common.save': 'Save',
        'common.delete': 'Delete',
        'common.edit': 'Edit',
        'common.close': 'Close',
        'common.back': 'Back',
        'common.next': 'Next',
        'common.previous': 'Previous',
        'common.submit': 'Submit',
        'common.search': 'Search',
        'common.filter': 'Filter',
        'common.sort': 'Sort',
        'common.yes': 'Yes',
        'common.no': 'No',
        
        // Navigation
        'nav.home': 'Home',
        'nav.about': 'About',
        'nav.contact': 'Contact',
        'nav.emergency': 'Emergency',
        'nav.login': 'Login',
        'nav.register': 'Register',
        'nav.dashboard': 'Dashboard',
        'nav.profile': 'Profile',
        'nav.logout': 'Logout',
        
        // Emergency
        'emergency.title': 'Emergency Blood Request',
        'emergency.urgent': 'Urgent',
        'emergency.critical': 'Critical',
        'emergency.bloodType': 'Blood Type',
        'emergency.location': 'Location',
        'emergency.hospital': 'Hospital',
        'emergency.contact': 'Contact',
        'emergency.submit': 'Submit Request',
        'emergency.success': 'Emergency request submitted successfully',
        
        // Authentication
        'auth.login': 'Login',
        'auth.register': 'Register',
        'auth.email': 'Email',
        'auth.password': 'Password',
        'auth.confirmPassword': 'Confirm Password',
        'auth.phone': 'Phone Number',
        'auth.forgotPassword': 'Forgot Password?',
        'auth.resetPassword': 'Reset Password',
        'auth.loginSuccess': 'Login successful',
        'auth.registerSuccess': 'Registration successful',
        
        // Donor
        'donor.dashboard': 'Donor Dashboard',
        'donor.profile': 'Donor Profile',
        'donor.history': 'Donation History',
        'donor.availability': 'Availability',
        'donor.certificates': 'Certificates',
        'donor.bloodType': 'Blood Type',
        'donor.lastDonation': 'Last Donation',
        'donor.totalDonations': 'Total Donations',
        
        // Notifications
        'notification.newRequest': 'New blood request in your area',
        'notification.requestAccepted': 'Your blood request has been accepted',
        'notification.donationReminder': 'Time for your next donation',
        'notification.emergencyAlert': 'Emergency blood request - immediate help needed',
        
        // Time and Date
        'time.now': 'now',
        'time.minutesAgo': '{count} minutes ago',
        'time.hoursAgo': '{count} hours ago',
        'time.daysAgo': '{count} days ago',
        'time.today': 'Today',
        'time.yesterday': 'Yesterday',
        'time.tomorrow': 'Tomorrow',
        
        // Blood Types
        'bloodType.aPositive': 'A+',
        'bloodType.aNegative': 'A-',
        'bloodType.bPositive': 'B+',
        'bloodType.bNegative': 'B-',
        'bloodType.abPositive': 'AB+',
        'bloodType.abNegative': 'AB-',
        'bloodType.oPositive': 'O+',
        'bloodType.oNegative': 'O-',
        
        // Accessibility
        'a11y.skipToMain': 'Skip to main content',
        'a11y.skipToNav': 'Skip to navigation',
        'a11y.openMenu': 'Open menu',
        'a11y.closeMenu': 'Close menu',
        'a11y.loading': 'Loading content',
        'a11y.error': 'Error occurred',
        'a11y.required': 'Required field',
        'a11y.optional': 'Optional field'
      },
      
      es: {
        // Common
        'common.loading': 'Cargando...',
        'common.error': 'Error',
        'common.success': '√âxito',
        'common.cancel': 'Cancelar',
        'common.save': 'Guardar',
        'common.delete': 'Eliminar',
        'common.edit': 'Editar',
        'common.close': 'Cerrar',
        'common.back': 'Atr√°s',
        'common.next': 'Siguiente',
        'common.previous': 'Anterior',
        'common.submit': 'Enviar',
        'common.search': 'Buscar',
        'common.filter': 'Filtrar',
        'common.sort': 'Ordenar',
        'common.yes': 'S√≠',
        'common.no': 'No',
        
        // Navigation
        'nav.home': 'Inicio',
        'nav.about': 'Acerca de',
        'nav.contact': 'Contacto',
        'nav.emergency': 'Emergencia',
        'nav.login': 'Iniciar Sesi√≥n',
        'nav.register': 'Registrarse',
        'nav.dashboard': 'Panel',
        'nav.profile': 'Perfil',
        'nav.logout': 'Cerrar Sesi√≥n',
        
        // Emergency
        'emergency.title': 'Solicitud de Sangre de Emergencia',
        'emergency.urgent': 'Urgente',
        'emergency.critical': 'Cr√≠tico',
        'emergency.bloodType': 'Tipo de Sangre',
        'emergency.location': 'Ubicaci√≥n',
        'emergency.hospital': 'Hospital',
        'emergency.contact': 'Contacto',
        'emergency.submit': 'Enviar Solicitud',
        'emergency.success': 'Solicitud de emergencia enviada exitosamente',
        
        // Authentication
        'auth.login': 'Iniciar Sesi√≥n',
        'auth.register': 'Registrarse',
        'auth.email': 'Correo Electr√≥nico',
        'auth.password': 'Contrase√±a',
        'auth.confirmPassword': 'Confirmar Contrase√±a',
        'auth.phone': 'N√∫mero de Tel√©fono',
        'auth.forgotPassword': '¬øOlvidaste tu contrase√±a?',
        'auth.resetPassword': 'Restablecer Contrase√±a',
        'auth.loginSuccess': 'Inicio de sesi√≥n exitoso',
        'auth.registerSuccess': 'Registro exitoso',
        
        // Donor
        'donor.dashboard': 'Panel del Donante',
        'donor.profile': 'Perfil del Donante',
        'donor.history': 'Historial de Donaciones',
        'donor.availability': 'Disponibilidad',
        'donor.certificates': 'Certificados',
        'donor.bloodType': 'Tipo de Sangre',
        'donor.lastDonation': '√öltima Donaci√≥n',
        'donor.totalDonations': 'Total de Donaciones',
        
        // Notifications
        'notification.newRequest': 'Nueva solicitud de sangre en tu √°rea',
        'notification.requestAccepted': 'Tu solicitud de sangre ha sido aceptada',
        'notification.donationReminder': 'Es hora de tu pr√≥xima donaci√≥n',
        'notification.emergencyAlert': 'Solicitud de sangre de emergencia - se necesita ayuda inmediata',
        
        // Time and Date
        'time.now': 'ahora',
        'time.minutesAgo': 'hace {count} minutos',
        'time.hoursAgo': 'hace {count} horas',
        'time.daysAgo': 'hace {count} d√≠as',
        'time.today': 'Hoy',
        'time.yesterday': 'Ayer',
        'time.tomorrow': 'Ma√±ana',
        
        // Blood Types
        'bloodType.aPositive': 'A+',
        'bloodType.aNegative': 'A-',
        'bloodType.bPositive': 'B+',
        'bloodType.bNegative': 'B-',
        'bloodType.abPositive': 'AB+',
        'bloodType.abNegative': 'AB-',
        'bloodType.oPositive': 'O+',
        'bloodType.oNegative': 'O-',
        
        // Accessibility
        'a11y.skipToMain': 'Saltar al contenido principal',
        'a11y.skipToNav': 'Saltar a la navegaci√≥n',
        'a11y.openMenu': 'Abrir men√∫',
        'a11y.closeMenu': 'Cerrar men√∫',
        'a11y.loading': 'Cargando contenido',
        'a11y.error': 'Ocurri√≥ un error',
        'a11y.required': 'Campo obligatorio',
        'a11y.optional': 'Campo opcional'
      },
      
      hi: {
        // Common
        'common.loading': '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
        'common.error': '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',
        'common.success': '‡§∏‡§´‡§≤‡§§‡§æ',
        'common.cancel': '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'common.save': '‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
        'common.delete': '‡§π‡§ü‡§æ‡§è‡§Ç',
        'common.edit': '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç',
        'common.close': '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'common.back': '‡§µ‡§æ‡§™‡§∏',
        'common.next': '‡§Ö‡§ó‡§≤‡§æ',
        'common.previous': '‡§™‡§ø‡§õ‡§≤‡§æ',
        'common.submit': '‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç',
        'common.search': '‡§ñ‡•ã‡§ú‡•á‡§Ç',
        'common.filter': '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞',
        'common.sort': '‡§ï‡•ç‡§∞‡§Æ‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞‡•á‡§Ç',
        'common.yes': '‡§π‡§æ‡§Å',
        'common.no': '‡§®‡§π‡•Ä‡§Ç',
        
        // Navigation
        'nav.home': '‡§π‡•ã‡§Æ',
        'nav.about': '‡§π‡§Æ‡§æ‡§∞‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç',
        'nav.contact': '‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï',
        'nav.emergency': '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤',
        'nav.login': '‡§≤‡•â‡§ó‡§ø‡§®',
        'nav.register': '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£',
        'nav.dashboard': '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
        'nav.profile': '‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤',
        'nav.logout': '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
        
        // Emergency
        'emergency.title': '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∞‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß',
        'emergency.urgent': '‡§§‡§§‡•ç‡§ï‡§æ‡§≤',
        'emergency.critical': '‡§ó‡§Ç‡§≠‡•Ä‡§∞',
        'emergency.bloodType': '‡§∞‡§ï‡•ç‡§§ ‡§∏‡§Æ‡•Ç‡§π',
        'emergency.location': '‡§∏‡•ç‡§•‡§æ‡§®',
        'emergency.hospital': '‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤',
        'emergency.contact': '‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï',
        'emergency.submit': '‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§≠‡•á‡§ú‡•á‡§Ç',
        'emergency.success': '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ',
        
        // Authentication
        'auth.login': '‡§≤‡•â‡§ó‡§ø‡§®',
        'auth.register': '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£',
        'auth.email': '‡§à‡§Æ‡•á‡§≤',
        'auth.password': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
        'auth.confirmPassword': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',
        'auth.phone': '‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞',
        'auth.forgotPassword': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?',
        'auth.resetPassword': '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç',
        'auth.loginSuccess': '‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤',
        'auth.registerSuccess': '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§∏‡§´‡§≤',
        
        // Donor
        'donor.dashboard': '‡§¶‡§æ‡§§‡§æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
        'donor.profile': '‡§¶‡§æ‡§§‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤',
        'donor.history': '‡§¶‡§æ‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏',
        'donor.availability': '‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ',
        'donor.certificates': '‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞',
        'donor.bloodType': '‡§∞‡§ï‡•ç‡§§ ‡§∏‡§Æ‡•Ç‡§π',
        'donor.lastDonation': '‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¶‡§æ‡§®',
        'donor.totalDonations': '‡§ï‡•Å‡§≤ ‡§¶‡§æ‡§®',
        
        // Notifications
        'notification.newRequest': '‡§Ü‡§™‡§ï‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§®‡§Ø‡§æ ‡§∞‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß',
        'notification.requestAccepted': '‡§Ü‡§™‡§ï‡§æ ‡§∞‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à',
        'notification.donationReminder': '‡§Ü‡§™‡§ï‡•á ‡§Ö‡§ó‡§≤‡•á ‡§¶‡§æ‡§® ‡§ï‡§æ ‡§∏‡§Æ‡§Ø',
        'notification.emergencyAlert': '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∞‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß - ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ',
        
        // Time and Date
        'time.now': '‡§Ö‡§≠‡•Ä',
        'time.minutesAgo': '{count} ‡§Æ‡§ø‡§®‡§ü ‡§™‡§π‡§≤‡•á',
        'time.hoursAgo': '{count} ‡§ò‡§Ç‡§ü‡•á ‡§™‡§π‡§≤‡•á',
        'time.daysAgo': '{count} ‡§¶‡§ø‡§® ‡§™‡§π‡§≤‡•á',
        'time.today': '‡§Ü‡§ú',
        'time.yesterday': '‡§ï‡§≤',
        'time.tomorrow': '‡§ï‡§≤',
        
        // Blood Types
        'bloodType.aPositive': 'A+',
        'bloodType.aNegative': 'A-',
        'bloodType.bPositive': 'B+',
        'bloodType.bNegative': 'B-',
        'bloodType.abPositive': 'AB+',
        'bloodType.abNegative': 'AB-',
        'bloodType.oPositive': 'O+',
        'bloodType.oNegative': 'O-',
        
        // Accessibility
        'a11y.skipToMain': '‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç',
        'a11y.skipToNav': '‡§®‡•á‡§µ‡•Ä‡§ó‡•á‡§∂‡§® ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç',
        'a11y.openMenu': '‡§Æ‡•á‡§®‡•Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç',
        'a11y.closeMenu': '‡§Æ‡•á‡§®‡•Ç ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'a11y.loading': '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à',
        'a11y.error': '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à',
        'a11y.required': '‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§°',
        'a11y.optional': '‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§°'
      }
    };
    
    return translations[languageCode] || translations.en;
  }

  // Set current language
  async setLanguage(languageCode) {
    if (!this.supportedLanguages[languageCode]) {
      console.warn(`[i18n] Unsupported language: ${languageCode}`);
      return;
    }
    
    // Load language if not already loaded
    if (!this.loadedLanguages.has(languageCode)) {
      await this.loadLanguage(languageCode);
    }
    
    const previousLanguage = this.currentLanguage;
    this.currentLanguage = languageCode;
    
    // Store preference
    localStorage.setItem('preferred-language', languageCode);
    
    // Update document language
    document.documentElement.lang = languageCode;
    
    // Apply directionality
    this.applyDirectionality();
    
    // Update formatters
    this.setupFormatters();
    
    // Notify listeners
    this.notifyLanguageChange(languageCode, previousLanguage);
    
    console.log(`[i18n] Language changed to: ${languageCode}`);
  }

  // Apply text directionality (RTL/LTR)
  applyDirectionality() {
    const language = this.supportedLanguages[this.currentLanguage];
    const direction = language.rtl ? 'rtl' : 'ltr';
    
    document.documentElement.dir = direction;
    document.body.classList.toggle('rtl', language.rtl);
    document.body.classList.toggle('ltr', !language.rtl);
  }

  // Setup number and date formatters
  setupFormatters() {
    const language = this.supportedLanguages[this.currentLanguage];
    const locale = language.locale;
    
    // Number formatter
    this.formatters.set('number', new Intl.NumberFormat(locale));
    
    // Currency formatter (assuming USD for now)
    this.formatters.set('currency', new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: 'USD'
    }));
    
    // Date formatters
    this.formatters.set('date', new Intl.DateTimeFormat(locale));
    this.formatters.set('dateTime', new Intl.DateTimeFormat(locale, {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }));
    this.formatters.set('time', new Intl.DateTimeFormat(locale, {
      hour: '2-digit',
      minute: '2-digit'
    }));
    
    // Relative time formatter
    if ('RelativeTimeFormat' in Intl) {
      this.formatters.set('relativeTime', new Intl.RelativeTimeFormat(locale, {
        numeric: 'auto'
      }));
    }
  }

  // Translate text with interpolation
  t(key, params = {}) {
    const translations = this.translations.get(this.currentLanguage);
    const fallbackTranslations = this.translations.get(this.fallbackLanguage);
    
    let text = translations?.[key] || fallbackTranslations?.[key] || key;
    
    // Handle interpolation
    if (params && typeof text === 'string') {
      text = text.replace(/\{(\w+)\}/g, (match, paramKey) => {
        return params[paramKey] !== undefined ? params[paramKey] : match;
      });
    }
    
    return text;
  }

  // Format number
  formatNumber(number, options = {}) {
    try {
      const formatter = this.formatters.get('number');
      return formatter.format(number);
    } catch (error) {
      console.error('[i18n] Number formatting error:', error);
      return number.toString();
    }
  }

  // Format currency
  formatCurrency(amount, currency = 'USD') {
    try {
      const language = this.supportedLanguages[this.currentLanguage];
      const formatter = new Intl.NumberFormat(language.locale, {
        style: 'currency',
        currency
      });
      return formatter.format(amount);
    } catch (error) {
      console.error('[i18n] Currency formatting error:', error);
      return `${currency} ${amount}`;
    }
  }

  // Format date
  formatDate(date, options = {}) {
    try {
      const language = this.supportedLanguages[this.currentLanguage];
      const formatter = new Intl.DateTimeFormat(language.locale, options);
      return formatter.format(new Date(date));
    } catch (error) {
      console.error('[i18n] Date formatting error:', error);
      return new Date(date).toLocaleDateString();
    }
  }

  // Format relative time
  formatRelativeTime(date) {
    try {
      const now = new Date();
      const targetDate = new Date(date);
      const diffInSeconds = Math.floor((targetDate - now) / 1000);
      
      const rtf = this.formatters.get('relativeTime');
      if (rtf) {
        if (Math.abs(diffInSeconds) < 60) {
          return rtf.format(diffInSeconds, 'second');
        } else if (Math.abs(diffInSeconds) < 3600) {
          return rtf.format(Math.floor(diffInSeconds / 60), 'minute');
        } else if (Math.abs(diffInSeconds) < 86400) {
          return rtf.format(Math.floor(diffInSeconds / 3600), 'hour');
        } else {
          return rtf.format(Math.floor(diffInSeconds / 86400), 'day');
        }
      }
      
      // Fallback
      const minutes = Math.floor(Math.abs(diffInSeconds) / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) {
        return this.t('time.daysAgo', { count: days });
      } else if (hours > 0) {
        return this.t('time.hoursAgo', { count: hours });
      } else if (minutes > 0) {
        return this.t('time.minutesAgo', { count: minutes });
      } else {
        return this.t('time.now');
      }
    } catch (error) {
      console.error('[i18n] Relative time formatting error:', error);
      return new Date(date).toLocaleDateString();
    }
  }

  // Get current language info
  getCurrentLanguage() {
    return this.supportedLanguages[this.currentLanguage];
  }

  // Get all supported languages
  getSupportedLanguages() {
    return Object.values(this.supportedLanguages);
  }

  // Check if language is RTL
  isRTL() {
    return this.supportedLanguages[this.currentLanguage]?.rtl || false;
  }

  // Add language change listener
  addLanguageChangeListener(callback) {
    this.listeners.add(callback);
    return () => this.listeners.delete(callback);
  }

  // Notify language change
  notifyLanguageChange(newLanguage, previousLanguage) {
    this.listeners.forEach(callback => {
      try {
        callback(newLanguage, previousLanguage);
      } catch (error) {
        console.error('[i18n] Language change listener error:', error);
      }
    });
  }

  // Get translation keys for a namespace
  getTranslationKeys(namespace = '') {
    const translations = this.translations.get(this.currentLanguage) || {};
    
    if (!namespace) {
      return Object.keys(translations);
    }
    
    return Object.keys(translations).filter(key => key.startsWith(namespace));
  }

  // Check if translation exists
  hasTranslation(key) {
    const translations = this.translations.get(this.currentLanguage);
    const fallbackTranslations = this.translations.get(this.fallbackLanguage);
    
    return !!(translations?.[key] || fallbackTranslations?.[key]);
  }

  // Get missing translations
  getMissingTranslations() {
    const currentTranslations = this.translations.get(this.currentLanguage) || {};
    const fallbackTranslations = this.translations.get(this.fallbackLanguage) || {};
    
    const missing = [];
    
    for (const key of Object.keys(fallbackTranslations)) {
      if (!currentTranslations[key]) {
        missing.push(key);
      }
    }
    
    return missing;
  }

  // Pluralization helper
  plural(key, count, params = {}) {
    const pluralKey = count === 1 ? `${key}.singular` : `${key}.plural`;
    
    if (this.hasTranslation(pluralKey)) {
      return this.t(pluralKey, { count, ...params });
    }
    
    // Fallback to regular translation
    return this.t(key, { count, ...params });
  }

  // Get language direction class
  getDirectionClass() {
    return this.isRTL() ? 'rtl' : 'ltr';
  }

  // Get language-specific CSS classes
  getLanguageClasses() {
    const language = this.getCurrentLanguage();
    return [
      `lang-${language.code}`,
      `locale-${language.locale}`,
      language.rtl ? 'rtl' : 'ltr'
    ].join(' ');
  }
}

// Create singleton instance
const i18n = new I18nManager();

export default i18n;